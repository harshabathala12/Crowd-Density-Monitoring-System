<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDMS | University Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #0f172a; color: #e2e8f0; }
        .panel { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 1.5rem; }
        .live-feed { border: 2px solid #334155; border-radius: 4px; overflow: hidden; position: relative; }
        .status-safe { color: #22c55e; }
        .status-warn { color: #f97316; }
        .status-danger { color: #ef4444; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .btn { cursor: pointer; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="p-6">

    <!-- HEADER -->
    <header class="mb-6 flex justify-between items-center border-b border-gray-700 pb-4">
        <div>
            <!-- FIXED TITLE -->
            <h1 class="text-2xl font-bold text-white">CROWD DENSITY MONITORING SYSTEM</h1>
            <!-- FIXED SUBTITLE -->
            <p class="text-gray-400 text-sm">Autonomous Real-Time Situational Awareness</p>
        </div>
        <div class="text-right">
            <div id="connection-status" class="text-xs text-green-400">● SYSTEM ONLINE</div>
            <div class="text-xs text-gray-500">Latency Optimized Build</div>
        </div>
    </header>

    <div class="grid grid-cols-12 gap-6">
        
        <!-- LEFT COLUMN: VIDEO -->
        <div class="col-span-8">
            <div class="panel">
                <div class="flex justify-between mb-2">
                    <h2 class="text-lg font-bold">LIVE OPTICAL FEED</h2>
                    <span id="live-clock" class="text-sm text-gray-400">--:--:--</span>
                </div>
                
                <!-- VIDEO PLAYER -->
                <div class="live-feed bg-black aspect-video flex items-center justify-center">
                    <img id="video_stream" src="{{ url_for('video_feed') }}" class="w-full h-full object-contain">
                    
                    <!-- ALERT OVERLAY -->
                    <div id="overlay-alert" class="hidden absolute inset-0 bg-red-900/80 flex flex-col items-center justify-center z-10">
                        <h1 class="text-4xl font-bold text-white mb-2">⚠ DENSITY THRESHOLD BREACHED ⚠</h1>
                        <p class="text-white text-xl mb-6">Automated Halt Protocol Initiated</p>
                        
                        <div id="alert-message" class="bg-black/50 p-4 rounded border border-red-500 text-center mb-6">
                            <!-- Directive goes here -->
                        </div>

                        <button onclick="controlVideo('continue')" class="bg-white text-red-900 font-bold py-3 px-8 rounded hover:bg-gray-200">
                            ACKNOWLEDGE & RESUME
                        </button>
                    </div>
                </div>

                <!-- CONTROLS -->
                <div class="mt-4 flex gap-4">
                    <button onclick="controlVideo('play')" class="btn bg-blue-600 px-4 py-2 rounded text-white font-bold">▶ Start Feed</button>
                    <button onclick="controlVideo('pause')" class="btn bg-gray-600 px-4 py-2 rounded text-white font-bold">⏸ Freeze</button>
                    <button onclick="controlVideo('replay')" class="btn bg-gray-600 px-4 py-2 rounded text-white font-bold">⟳ System Reset</button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: METRICS -->
        <div class="col-span-4 space-y-6">
            
            <!-- STATUS CARD -->
            <div class="panel">
                <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-1">Current Status</h3>
                <div id="main-status" class="text-4xl font-bold text-white">INITIALIZING</div>
            </div>

            <!-- DECISION SUPPORT -->
            <div class="panel border-l-4 border-blue-500">
                <h3 class="text-blue-400 text-xs uppercase tracking-wider mb-2">Operational Directive</h3>
                <div id="recommendation-text" class="text-sm leading-relaxed">
                    System awaiting input...
                </div>
            </div>

            <!-- METRICS GRID -->
            <div class="panel">
                <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-4">Live Telemetry</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="text-gray-500 text-xs">Congestion Index</div>
                        <div id="score-val" class="text-2xl font-bold text-white">0.0</div>
                        <div class="text-xs text-gray-600">Scale: 0-100</div>
                    </div>
                    <div class="bg-gray-800 p-3 rounded">
                        <div class="text-gray-500 text-xs">Occupancy</div>
                        <div id="occupancy-val" class="text-2xl font-bold text-white">0</div>
                        <div class="text-xs text-gray-600">Persons</div>
                    </div>
                </div>
                <div class="mt-4 text-xs text-gray-500">
                    <div>Engine: <span class="text-white">Deterministic V2.0</span></div>
                    <div>Detector: <span class="text-white">YOLOv8n (GPU)</span></div>
                    <div>Alert Email: <span class="text-white" id="receiver-email">...</span></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function updateDashboard() {
            $.getJSON('/get_status', function(data) {
                // Update Values
                $('#score-val').text(data.score);
                $('#occupancy-val').text(data.occupancy);
                $('#recommendation-text').html(data.recommendation);
                $('#receiver-email').text(data.receiver_email);

                // Status Logic
                const statusElem = $('#main-status');
                statusElem.text(data.status);
                statusElem.removeClass('status-safe status-warn status-danger');

                if (data.status === 'NORMAL') statusElem.addClass('status-safe');
                else if (data.status === 'WARNING') statusElem.addClass('status-warn');
                else statusElem.addClass('status-danger');

                // Alert Overlay Logic
                if (data.alert_triggered) {
                    $('#overlay-alert').removeClass('hidden');
                    $('#alert-message').html(data.recommendation);
                } else {
                    $('#overlay-alert').addClass('hidden');
                }
            });
            
            // Clock
            const now = new Date();
            $('#live-clock').text(now.toLocaleTimeString());
        }

        function controlVideo(action) {
            $.getJSON('/control/' + action, function(resp) {
                console.log("Action: " + action);
            });
        }

        setInterval(updateDashboard, 500);
    </script>
</body>
</html>